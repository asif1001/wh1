<script type="module">
// --- Shipment Search Logic ---
let allShipments = [];
let allDocs = [];
const searchInput = document.querySelector('input[placeholder="Search shipments..."]');
const sourceSelect = document.querySelector('select'); // The first select is Source
function filterAndRenderShipments() {
    const q = searchInput.value.trim().toLowerCase();
    const selectedSource = sourceSelect.value;
    let filtered = allShipments.map((s, i) => ({s, i}));
    
    // Date filtering: last 45 days and all future shipments based on Bahrain ETA
    const now = new Date();
    const fortyFiveDaysAgo = new Date(now.getTime() - (45 * 24 * 60 * 60 * 1000));
    
    // Filter by date range first
    filtered = filtered.filter(({s}) => {
        const bahrainETA = s.bahrainETA || s.bahrainEta;
        if (bahrainETA) {
            let etaDate = null;
            if (bahrainETA.seconds) {
                etaDate = new Date(bahrainETA.seconds * 1000);
            } else if (bahrainETA) {
                etaDate = new Date(bahrainETA);
            }
            
            if (etaDate && !isNaN(etaDate)) {
                // Include if ETA is within last 45 days OR in the future
                return etaDate >= fortyFiveDaysAgo || etaDate >= now;
            }
        }
        // If no Bahrain ETA, include the shipment (fallback behavior)
        return true;
    });
    
    // Filter by source dropdown if not 'All Sources'
    if (selectedSource && selectedSource !== 'All Sources') {
        filtered = filtered.filter(({s}) => (s.source || '') === selectedSource);
    }
    // Filter by search input
    if (q) {
        filtered = filtered.filter(({s}) => {
            const invoice = (s.invoice || s.invoiceNo || '').toLowerCase();
            const blNo = (s.blNo || '').toLowerCase();
            const source = (s.source || '').toLowerCase();
            const bahrainETA = s.bahrainETA || s.bahrainEta;
            let etaStr = '';
            if (bahrainETA) {
                if (bahrainETA.seconds) {
                    etaStr = new Date(bahrainETA.seconds * 1000).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }).toLowerCase();
                } else if (typeof bahrainETA === 'string' || typeof bahrainETA === 'number') {
                    etaStr = new Date(bahrainETA).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }).toLowerCase();
                }
            }
            return (
                invoice.includes(q) ||
                blNo.includes(q) ||
                source.includes(q) ||
                etaStr.includes(q)
            );
        });
    }
    
    // Sort by Bahrain ETA in descending order (newest dates first)
    filtered.sort((a, b) => {
        const etaA = a.s.bahrainETA || a.s.bahrainEta;
        const etaB = b.s.bahrainETA || b.s.bahrainEta;
        
        // Convert to Date objects for comparison
        let dateA = null;
        let dateB = null;
        
        if (etaA) {
            if (etaA.seconds) {
                dateA = new Date(etaA.seconds * 1000);
            } else {
                dateA = new Date(etaA);
            }
        }
        
        if (etaB) {
            if (etaB.seconds) {
                dateB = new Date(etaB.seconds * 1000);
            } else {
                dateB = new Date(etaB);
            }
        }
        
        // Handle null/invalid dates - put them at the end
        if (!dateA || isNaN(dateA)) {
            if (!dateB || isNaN(dateB)) return 0; // Both invalid, maintain order
            return 1; // A is invalid, B is valid - B comes first
        }
        if (!dateB || isNaN(dateB)) {
            return -1; // B is invalid, A is valid - A comes first
        }
        
        // Both dates are valid - sort in descending order (newest first)
        return dateB.getTime() - dateA.getTime();
    });
    
    renderShipments(filtered.map(f => f.s), filtered.map(f => allDocs[f.i]));
}
if (searchInput) {
    searchInput.addEventListener('input', filterAndRenderShipments);
}
if (sourceSelect) {
    sourceSelect.addEventListener('change', filterAndRenderShipments);
}
const origRenderShipments = renderShipments;
function renderShipmentsWithStore(shipments, docs) {
    allShipments = shipments;
    allDocs = docs;
    // Apply date filtering when data is first loaded
    filterAndRenderShipments();
}
            import { db } from './firebase-config.js';
            import { collection, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

            const tbody = document.querySelector("tbody.bg-white");
            const loadingRow = document.getElementById("shipments-loading-row");
            const emptyState = document.getElementById("shipments-empty-state");
            // Modal elements are handled by the dedicated modal script further down.

            // Remove shipment from UI after delete
            function removeShipmentFromUI(docId) {
                // Remove from allShipments/allDocs and re-render
                if (Array.isArray(allDocs)) {
                    const idx = allDocs.findIndex(d => d && d.id === docId);
                    if (idx !== -1) {
                        allDocs.splice(idx, 1);
                        allShipments.splice(idx, 1);
                        renderShipmentsWithStore(allShipments, allDocs);
                    }
                }
            }
            let lastSnapshot = null;

            function formatDate(val) {
                if (!val) return '';
                if (val.seconds) return new Date(val.seconds * 1000).toISOString().slice(0, 10);
                if (typeof val === 'string') return new Date(val).toISOString().slice(0, 10);
                return '';
            }

            function formatDateDisplay(val) {
                if (!val) return 'â€”';
                const d = new Date(val.seconds ? val.seconds * 1000 : val);
                return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
            }

            // Function to check if shipment has booking data
            async function checkShipmentBookingStatus(shipmentId) {
                try {
                    const bookingQuery = query(
                        collection(db, 'booking'), 
                        where('shipmentId', '==', shipmentId)
                    );
                    const bookingSnapshot = await getDocs(bookingQuery);
                    return !bookingSnapshot.empty;
                } catch (err) {
                    console.error('Error checking booking status:', err);
                    return false;
                }
            }

            // Function to check if container data indicates booking
            function hasContainerBookingData(shipment) {
                // Check if containers array has booking information
                if (Array.isArray(shipment.containers)) {
                    return shipment.containers.some(container => 
                        container.number && container.number.trim() !== '' &&
                        container.bookingDate
                    );
                }
                // Check legacy container fields
                return (shipment.containerNumber && shipment.containerNumber.trim() !== '' &&
                        shipment.bookingDate);
            }

            async function renderShipments(shipments, docs) {
                tbody.innerHTML = '';
                if (!shipments.length) {
                    emptyState.classList.remove('hidden');
                    return;
                }
                emptyState.classList.add('hidden');
                
                // Check booking status for all shipments
                const bookingStatuses = await Promise.all(
                    docs.map(doc => checkShipmentBookingStatus(doc.id))
                );
                
                shipments.forEach((s, i) => {
                    const docId = docs[i].id;
                    const hasBookingCollection = bookingStatuses[i];
                    const hasContainerBooking = hasContainerBookingData(s);
                    const shouldHighlight = hasBookingCollection || hasContainerBooking;
                    // Color scale for Bahrain ETA
                    let eta = s.bahrainETA || s.bahrainEta;
                    let etaDate = null;
                    if (eta && eta.seconds) {
                        etaDate = new Date(eta.seconds * 1000);
                    } else if (eta) {
                        etaDate = new Date(eta);
                    }
                    let etaClass = "text-gray-500";
                    if (etaDate) {
                        const now = new Date();
                        const diffDays = Math.ceil((etaDate - now) / (1000 * 60 * 60 * 24));
                        if (diffDays >= 0 && diffDays <= 3) {
                            etaClass = "text-red-600 font-semibold";
                        } else if (diffDays >= 4 && diffDays <= 8) {
                            etaClass = "text-orange-500 font-semibold";
                        } else if (diffDays >= 9 && diffDays <= 12) {
                            etaClass = "text-green-600 font-semibold";
                        }
                    }
                    // Color scale for Actual Bahrain ETA (single declaration)
                    let actualEtaClass = "text-gray-500";
                    let actualEtaDate = null;
                    if (s.actualBahrainETA) {
                        if (s.actualBahrainETA.seconds) {
                            actualEtaDate = new Date(s.actualBahrainETA.seconds * 1000);
                        } else if (typeof s.actualBahrainETA === 'string' || typeof s.actualBahrainETA === 'number') {
                            const d = new Date(s.actualBahrainETA);
                            if (!isNaN(d)) actualEtaDate = d;
                        }
                    }
                    if (actualEtaDate) {
                        const now = new Date();
                        const diffDays = Math.ceil((actualEtaDate - now) / (1000 * 60 * 60 * 24));
                        if (diffDays >= 0 && diffDays <= 3) {
                            actualEtaClass = "text-red-600 font-semibold";
                        } else if (diffDays >= 4 && diffDays <= 8) {
                            actualEtaClass = "text-orange-500 font-semibold";
                        } else if (diffDays >= 9 && diffDays <= 12) {
                            actualEtaClass = "text-green-600 font-semibold";
                        }
                    }
                    // Render containers column as summary string if containers array exists
                    let containersSummary = 'â€”';
                    if (Array.isArray(s.containers) && s.containers.length > 0) {
                        containersSummary = s.containers.map(c => `${c.count} x ${c.size}`).join(', ');
                    } else if (s.containerCount && s.containerSize) {
                        containersSummary = `${s.containerCount} x ${s.containerSize}`;
                    }
                    // Format Actual Bahrain ETA robustly
                    let actualBahrainETAValue = '';
                    if (s.actualBahrainETA) {
                        if (s.actualBahrainETA.seconds) {
                            // Firestore Timestamp
                            actualBahrainETAValue = new Date(s.actualBahrainETA.seconds * 1000).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
                        } else if (typeof s.actualBahrainETA === 'string' || typeof s.actualBahrainETA === 'number') {
                            const d = new Date(s.actualBahrainETA);
                            if (!isNaN(d)) actualBahrainETAValue = d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
                        }
                    }
                    tbody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.source || 'â€”'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 ${shouldHighlight ? 'booked-field' : ''}">${s.invoice || s.invoiceNo || 'â€”'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 ${shouldHighlight ? 'booked-field' : ''}">${containersSummary}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 ${shouldHighlight ? 'booked-field' : ''}">${s.blNo || 'â€”'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${etaClass}">${formatDateDisplay(eta)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${actualEtaClass}">${actualBahrainETAValue || 'â€”'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="text-indigo-600 hover:text-indigo-900 mr-3 view-shipment-btn" data-docid="${docId}"><i data-feather="edit" class="w-4 h-4"></i></button>
                                <button class="text-gray-600 hover:text-gray-900 book-shipment-btn" data-docid="${docId}" title="Book shipment"><i data-feather="book" class="w-5 h-5"></i></button>
                            </td>
                        </tr>
                    `;
                });
                feather.replace();
                // Add event listeners for all eye buttons
                document.querySelectorAll('.view-shipment-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const docId = btn.getAttribute('data-docid');
                        openDetailModal(docId);
                    });
                });
            }

            // Modal open/close logic is implemented in the dedicated modal script at the end of the file.

            // NOTE: duplicate/older submit handler removed to avoid conflicts. A single, hardened
            // submit handler is defined later in the file which defensively checks fields.

            // Live Firestore listener
            loadingRow.classList.remove('hidden');
            emptyState.classList.add('hidden');
            const shipmentsQuery = query(collection(db, 'shipments'), orderBy('createdAt', 'desc'));
            onSnapshot(shipmentsQuery, (snapshot) => {
                loadingRow.classList.add('hidden');
                lastSnapshot = snapshot;
                const shipments = snapshot.docs.map(doc => doc.data());
                renderShipmentsWithStore(shipments, snapshot.docs);
            });
        </script>

        <!-- Booking Shipment Confirmation Modal -->
    <div id="bookingModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4" style="z-index:9999;">
            <div class="bg-white rounded-lg shadow-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto p-6 relative">
                <button id="closeBookingModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Booking Shipment Confirmation</h2>
                <div id="bookingLoading" class="text-center text-gray-500 py-6">Loading...</div>
                <div id="bookingNotFound" class="text-center text-red-500 py-6 hidden">Shipment not found.</div>
                
                <form id="bookingForm" class="hidden">
                    <div id="bookingShipmentSummary" class="mb-4 text-sm text-gray-700"></div>
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-sm text-gray-700">Containers to book</div>
                                <button type="button" id="addBookingContainerBtn" class="text-indigo-600 hover:text-indigo-800 text-sm">+ Add container</button>
                            </div>
                            <div id="bookingContainers" class="space-y-3">
                                <!-- container booking rows injected here -->
                            </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" id="bookingCancelBtn" class="px-4 py-2 border rounded">Cancel</button>
                        <button type="submit" id="bookingCreateBtn" class="px-4 py-2 bg-indigo-600 text-white rounded">Update</button>
                    </div>
                </form>
            </div>
        </div>

        <script type="module">
            import { db } from './firebase-config.js';
            import { doc, getDoc, addDoc, collection, query, where, getDocs, Timestamp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

            const bookingModal = document.getElementById('bookingModal');
            const bookingForm = document.getElementById('bookingForm');
            const bookingLoading = document.getElementById('bookingLoading');
            const bookingNotFound = document.getElementById('bookingNotFound');
            const bookingContainers = document.getElementById('bookingContainers');
            const bookingSummary = document.getElementById('bookingShipmentSummary');


            const closeBookingBtn = document.getElementById('closeBookingModal');
            const bookingCancelBtn = document.getElementById('bookingCancelBtn');
            let bookingDocId = null;
            let bookingShipmentData = null;
            let bookingAllowedCount = 0; // exact number of allowed container rows

            function reindexBookingRows() {
                const rows = Array.from(bookingContainers.children);
                rows.forEach((row, idx) => {
                    const label = row.querySelector('label');
                    if (label) label.textContent = `Container #${idx+1}`;
                    const num = row.querySelector('[name^="containerNumber_"]');
                    const size = row.querySelector('[name^="containerSize_"]');
                    const date = row.querySelector('[name^="bookingDate_"]');
                    if (num) num.setAttribute('name', `containerNumber_${idx}`);
                    if (size) size.setAttribute('name', `containerSize_${idx}`);
                    if (date) date.setAttribute('name', `bookingDate_${idx}`);
                });
            }

            function makeBookingRow(c, idx, allowRemove = true) {
                // Ensure c is an object with default values
                const container = c || {};
                const bookingDateVal = container.bookingDate ? (new Date(container.bookingDate).toISOString().slice(0,10)) : '';
                const row = document.createElement('div');
                row.className = 'grid grid-cols-3 gap-3 items-center';
                row.innerHTML = `
                    <div>
                        <label class="text-sm text-gray-600">Container #${idx+1}</label>
                        <input name="containerNumber_${idx}" class="mt-1 w-full border rounded px-2 py-2" placeholder="Enter container number" value="${container.number || ''}" />
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Container Size</label>
                        <input name="containerSize_${idx}" class="mt-1 w-full border rounded px-2 py-2 bg-gray-50" value="${container.size || ''}" />
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="flex-1">
                            <label class="text-sm text-gray-600">Booking Date</label>
                            <input type="date" name="bookingDate_${idx}" class="mt-1 w-full border rounded px-2 py-2" value="${bookingDateVal}" />
                        </div>
                        ${allowRemove ? '<button type="button" class="remove-booking-row text-red-500 ml-2" title="Remove"><i data-feather="trash-2" class="w-5 h-5"></i></button>' : ''}
                    </div>
                `;
                return row;
            }

            function expandGroupedContainers(containers) {
                // containers may be [{size:'40', count:2}, {size:'20', count:2}] or [{size:'40'}]
                const out = [];
                if (!Array.isArray(containers) || containers.length === 0) return out;
                containers.forEach(c => {
                    // Ensure c is an object with default values
                    const container = c || {};
                    const cnt = Number(container.count) || 1;
                    for (let i = 0; i < cnt; i++) {
                        out.push({ size: container.size || '', number: '', bookingDate: '' });
                    }
                });
                return out;
            }

            function renderBookingRows(containers) {
                bookingContainers.innerHTML = '';
                // Expand grouped containers into individual rows
                let rowsData = [];
                if (Array.isArray(containers) && containers.length > 0) {
                    rowsData = expandGroupedContainers(containers);
                }
                // If no container data, show at least one empty row
                if (rowsData.length === 0) rowsData = [{ size: '', number: '', bookingDate: '' }];

                rowsData.forEach((c, idx) => {
                    // do not allow removing rows when strict count enforced
                    const row = makeBookingRow(c, idx, false);
                    bookingContainers.appendChild(row);
                });

                // since strict count is enforced, hide/disable remove buttons (none rendered)
                feather.replace();
            }

            // Add container button
            const addBookingContainerBtn = document.getElementById('addBookingContainerBtn');
            addBookingContainerBtn && addBookingContainerBtn.addEventListener('click', () => {
                // only allow adding if we haven't reached allowed count (should normally be disabled)
                const current = bookingContainers.children.length;
                if (bookingAllowedCount && current >= bookingAllowedCount) return;
                const idx = current;
                const row = makeBookingRow({ size: '', number: '', bookingDate: '' }, idx, true);
                bookingContainers.appendChild(row);
                reindexBookingRows();
                feather.replace();
            });

            // Function to check for existing booking data
            async function checkExistingBooking(shipmentId) {
                try {
                    const bookingQuery = query(
                        collection(db, 'booking'), 
                        where('shipmentId', '==', shipmentId)
                    );
                    const bookingSnapshot = await getDocs(bookingQuery);
                    
                    if (!bookingSnapshot.empty) {
                        // Found existing booking(s) - sort by creation date (newest first)
                        const bookings = [];
                        bookingSnapshot.forEach(doc => {
                            bookings.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // Sort bookings by createdAt timestamp (newest first)
                        bookings.sort((a, b) => {
                            const aTime = a.createdAt && a.createdAt.toDate ? a.createdAt.toDate().getTime() : 0;
                            const bTime = b.createdAt && b.createdAt.toDate ? b.createdAt.toDate().getTime() : 0;
                            return bTime - aTime;
                        });
                        
                        // Populate form with the most recent booking data
                        populateBookingForm(bookings[0]);
                        return true; // Booking data found
                    } else {
                        // No existing booking found - prepare empty form for manual input
                        prepareEmptyBookingForm();
                        return false; // No booking data found
                    }
                } catch (err) {
                    console.error('Error checking existing booking:', err);
                    prepareEmptyBookingForm();
                    return false;
                }
            }

            // Function to populate booking form with existing data
            function populateBookingForm(booking) {
                if (booking.bookingEntries && booking.bookingEntries.length > 0) {
                    // Clear existing container rows
                    bookingContainers.innerHTML = '';
                    
                    // Create rows for each existing booking entry
                    booking.bookingEntries.forEach((entry, index) => {
                        const containerData = {
                            number: entry.number || '',
                            size: entry.size || '',
                            bookingDate: entry.bookingDate && entry.bookingDate.toDate ? 
                                entry.bookingDate.toDate().toISOString().split('T')[0] : 
                                (entry.bookingDate || '')
                        };
                        const row = makeBookingRow(containerData, index, true);
                        bookingContainers.appendChild(row);
                    });
                    
                    reindexBookingRows();
                    feather.replace();
                    
                    // Enable the add button if we haven't reached capacity
                    if (addBookingContainerBtn && bookingContainers.children.length < bookingAllowedCount) {
                        addBookingContainerBtn.disabled = false;
                        addBookingContainerBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                } else {
                    // Booking exists but no entries - prepare empty form
                    prepareEmptyBookingForm();
                }
            }

            // Function to prepare empty form for manual input
            function prepareEmptyBookingForm() {
                // Clear existing container rows
                bookingContainers.innerHTML = '';
                
                // Create empty rows based on shipment container count
                const containersForRows = Array.isArray(bookingShipmentData.containers) && bookingShipmentData.containers.length > 0 ? 
                    expandGroupedContainers(bookingShipmentData.containers) : 
                    [{ size: '', number: '', bookingDate: '' }];
                
                containersForRows.forEach((c, idx) => {
                    const row = makeBookingRow({ size: c.size || '', number: '', bookingDate: '' }, idx, false);
                    bookingContainers.appendChild(row);
                });
                
                feather.replace();
                
                // Disable add button since we're at capacity for new bookings
                if (addBookingContainerBtn) {
                    addBookingContainerBtn.disabled = true;
                    addBookingContainerBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }

            async function openBookingModal(docId) {
                bookingDocId = docId;
                bookingLoading.classList.remove('hidden');
                bookingNotFound.classList.add('hidden');
                bookingForm.classList.add('hidden');
                bookingModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                try {
                    const ref = doc(db, 'shipments', docId);
                    const snap = await getDoc(ref);
                    if (!snap.exists()) {
                        bookingLoading.classList.add('hidden');
                        bookingNotFound.classList.remove('hidden');
                        return;
                    }
                    bookingShipmentData = snap.data();
                    
                    // render basic summary
                    bookingSummary.innerHTML = `<strong>Source:</strong> ${bookingShipmentData.source || 'â€”'} &nbsp; <strong>Invoice:</strong> ${bookingShipmentData.invoice || 'â€”'} &nbsp; <strong>BL:</strong> ${bookingShipmentData.blNo || 'â€”'}`;
                    
                    // determine allowed count by summing counts in grouped containers (default 1)
                    if (Array.isArray(bookingShipmentData.containers) && bookingShipmentData.containers.length > 0) {
                        bookingAllowedCount = bookingShipmentData.containers.reduce((sum, ci) => sum + (Number(ci.count) || 1), 0);
                    } else {
                        bookingAllowedCount = 1;
                    }
                    
                    // Check for existing booking data - this will handle form population
                    const hasExistingBooking = await checkExistingBooking(docId);
                    
                    // Only render empty rows if no existing booking was found
                    if (!hasExistingBooking) {
                        // expand grouped containers into individual rows for rendering
                        const containersForRows = Array.isArray(bookingShipmentData.containers) && bookingShipmentData.containers.length > 0 ? expandGroupedContainers(bookingShipmentData.containers) : [];
                        renderBookingRows(containersForRows);
                        // enforce UI constraints: disable add if at capacity
                        if (addBookingContainerBtn) {
                            addBookingContainerBtn.disabled = true;
                            addBookingContainerBtn.classList.add('opacity-50','cursor-not-allowed');
                        }
                    }
                    bookingLoading.classList.add('hidden');
                    bookingForm.classList.remove('hidden');
                } catch (err) {
                    console.error('openBookingModal failed', err);
                    bookingLoading.classList.add('hidden');
                    bookingNotFound.classList.remove('hidden');
                }
            }

            // Wire book buttons after renderShipments runs
            function attachBookHandlers() {
                document.querySelectorAll('.book-shipment-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = btn.getAttribute('data-docid');
                        openBookingModal(id);
                    });
                });
            }

            // Use event delegation on the table body so handlers survive re-renders
            const tableBodyDelegator = document.querySelector('tbody.bg-white');
            if (tableBodyDelegator) {
                tableBodyDelegator.addEventListener('click', (e) => {
                    const btn = e.target.closest('.book-shipment-btn');
                    if (!btn) return;
                    e.preventDefault();
                    const id = btn.getAttribute('data-docid');
                    if (id) openBookingModal(id);
                });
            }

            closeBookingBtn && closeBookingBtn.addEventListener('click', () => {
                bookingModal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            });
            bookingCancelBtn && bookingCancelBtn.addEventListener('click', () => {
                bookingModal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            });

            bookingForm && bookingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!bookingShipmentData) return;
                
                // strict validation: number of rows must equal bookingAllowedCount
                const currentRows = bookingContainers.children.length;
                if (bookingAllowedCount && currentRows !== bookingAllowedCount) {
                    alert(`Booking requires exactly ${bookingAllowedCount} containers. You have ${currentRows}. Please adjust before submitting.`);
                    return;
                }
                
                // collect booking inputs (iterate actual rows rendered)
                const form = bookingForm;
                const bookingEntries = [];
                const rowsCount = bookingContainers ? bookingContainers.children.length : 0;
                let validationErrors = [];
                
                for (let i = 0; i < rowsCount; i++) {
                    const numEl = form ? form.querySelector(`[name="containerNumber_${i}"]`) : null;
                    const sizeEl = form ? form.querySelector(`[name="containerSize_${i}"]`) : null;
                    const dateEl = form ? form.querySelector(`[name="bookingDate_${i}"]`) : null;
                    const number = numEl && numEl.value ? numEl.value.trim() : '';
                    const size = sizeEl && sizeEl.value ? sizeEl.value.trim() : '';
                    const dateVal = dateEl && dateEl.value ? dateEl.value : '';
                    
                    // Validation: if container number or size has data, date must be provided
                    if ((number || size) && !dateVal) {
                        validationErrors.push(`Container ${i + 1}: Date is required when container number or size is provided.`);
                    }
                    
                    // Convert container number to uppercase
                    const upperNumber = number.toUpperCase();
                    const bookingDate = dateVal ? new Date(dateVal) : null;
                    bookingEntries.push({ number: upperNumber, size, bookingDate });
                }
                
                // Display validation errors if any
                if (validationErrors.length > 0) {
                    alert('Please fix the following errors:\n\n' + validationErrors.join('\n'));
                    return;
                }

                // Build booking doc payload: copy shipment fields and add bookingEntries
                const bookingPayload = Object.assign({}, bookingShipmentData);
                bookingPayload.bookingEntries = bookingEntries;
                bookingPayload.shipmentRefId = bookingDocId;
                bookingPayload.shipmentId = bookingDocId; // Add shipmentId for querying
                bookingPayload.createdAt = Timestamp.now(); // Add timestamp for proper sorting

                try {
                    // convert bookingDate to Timestamp if available
                    bookingPayload.bookingEntries = bookingEntries.map(be => {
                        // Ensure be is an object with default values
                        const entry = be || {};
                        return {
                            number: entry.number || '',
                            size: entry.size || '',
                            bookingDate: entry.bookingDate ? (typeof Timestamp !== 'undefined' ? Timestamp.fromDate(entry.bookingDate) : entry.bookingDate) : null
                        };
                    });
                    console.debug('[booking] payload', bookingPayload);
                    await addDoc(collection(db, 'booking'), bookingPayload);
                    
                    // Refresh the booking display after successful save
                    await checkExistingBooking(bookingDocId);
                    
                    // Re-render the shipments table to update row highlighting
                    if (lastSnapshot) {
                        const shipments = lastSnapshot.docs.map(doc => doc.data());
                        renderShipments(shipments, lastSnapshot.docs);
                    }
                    
                    if (window.toast) window.toast('Booking created', 'success');
                    bookingModal.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                } catch (err) {
                    console.error('Failed to create booking', err);
                    alert('Failed to create booking. ' + (err && err.message ? err.message : ''));
                }
            });

            // No need to rewrap renderShipments â€” delegation handles dynamic rows.
        </script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipment Monitor | WBA</title>
    <link rel="icon" type="image/x-icon" href="https://static.photos/abstract/320x240/1">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4F46E5"/>
</head>
<body class="bg-gray-50 min-h-screen flex">
    <!-- Sidebar (directly included, role-aware) -->
    <aside class="hidden md:flex flex-col w-64 bg-white border-r border-gray-200 min-h-screen p-4">
        <div class="flex items-center space-x-3 mb-8">
            <div class="bg-indigo-100 rounded-lg p-2">
                <i data-feather="box" class="text-indigo-600 w-5 h-5"></i>
            </div>
            <span class="text-xl font-bold text-gray-800">WBA Dashboard</span>
        </div>
        <nav class="space-y-2 mb-4">
            <a href="dashboard.html" class="flex items-center px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100">
                <i data-feather="home" class="w-5 h-5 mr-3"></i> Dashboard
            </a>
            <a href="tasks.html" class="flex items-center px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100">
                <i data-feather="check-square" class="w-5 h-5 mr-3"></i> Tasks
            </a>
            <a href="shipments.html" class="flex items-center px-4 py-3 rounded-lg text-indigo-700 bg-indigo-50 font-semibold">
                <i data-feather="truck" class="w-5 h-5 mr-3"></i> Shipments
            </a>
            <a href="complaints.html" class="flex items-center px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100">
                <i data-feather="alert-circle" class="w-5 h-5 mr-3"></i> Complaints
            </a>
            <a href="admin-page.html" class="flex items-center px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100" id="adminPanelLink">
                <i data-feather="settings" class="w-5 h-5 mr-3"></i> Admin Panel
            </a>
        </nav>
        <div class="mt-2">
            <div class="flex items-center space-x-2 mb-2">
                <i data-feather="user" class="w-4 h-4 text-gray-400"></i>
                <span class="user-email text-gray-700 text-sm">Loading...</span>
            </div>
            <button onclick="logout()" class="flex items-center w-full px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg">
                <i data-feather="log-out" class="w-5 h-5 mr-2"></i> Logout
            </button>
        </div>
    </aside>
    <script>
        // Dynamically load sidebar.html into #sidebar-container
        fetch('sidebar.html')
            .then(response => response.text())
            .then(html => {
                const sidebarContainer = document.getElementById('sidebar-container');
                if (sidebarContainer) {
                    sidebarContainer.innerHTML = html;
                    if (window.feather) feather.replace();
                }
            })
            .catch(error => {
                console.warn('Could not load sidebar:', error);
            });
    </script>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
        <!-- Mobile Top Bar -->
        <header class="md:hidden bg-white shadow-sm p-4 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="bg-indigo-100 rounded-lg p-2">
                    <i data-feather="box" class="text-indigo-600 w-5 h-5"></i>
                </div>
                <h1 class="text-lg font-bold text-gray-800">WBA</h1>
            </div>
            <button id="menu-toggle" class="text-gray-600">
                <i data-feather="menu"></i>
            </button>
        </header>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="md:hidden fixed inset-0 bg-white z-50 hidden">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">Menu</h2>
                    <button id="close-menu" class="text-gray-600">
                        <i data-feather="x"></i>
                    </button>
                </div>
            </div>
            <nav class="mt-4">
                <a href="dashboard.html" class="block px-6 py-4 text-gray-600">
                    <i data-feather="home" class="inline mr-2"></i> Dashboard
                </a>
                <a href="tasks.html" class="block px-6 py-4 text-gray-600">
                    <i data-feather="check-square" class="inline mr-2"></i> Task Manager
                </a>
                <a href="#" class="block px-6 py-4 bg-indigo-50 text-indigo-700 border-l-4 border-indigo-700">
                    <i data-feather="truck" class="inline mr-2"></i> Shipment Monitor
                </a>
                <a href="complaints.html" class="block px-6 py-4 text-gray-600">
                    <i data-feather="alert-circle" class="inline mr-2"></i> Complaint Report
                </a>
            </nav>
        </div>

        <!-- Main Content Area -->
        <main class="flex-1 p-6">
            <div class="mb-8">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Shipment Monitor</h1>
                        <p class="text-gray-600">Track your shipments in real-time</p>
                    </div>
                    <div class="mt-4 md:mt-0">
                        <button onclick="openShipmentForm()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg flex items-center">
                            <i data-feather="plus" class="mr-2"></i> New Shipment
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-xl shadow p-6 mb-6" data-aos="fade-up">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-2">Source</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option>All Sources</option>
                            <option>TMC</option>
                            <option>TMAP</option>
                            <option>TMAP-OIL</option>
                            <option>TMHC</option>
                            <option>OTHER</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Date Range</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option>Last 7 Days</option>
                            <option>Last 30 Days</option>
                            <option>Last 90 Days</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Search</label>
                        <div class="relative">
                            <input type="text" class="w-full px-3 py-2 pl-10 border border-gray-300 rounded-lg" placeholder="Search shipments...">
                            <i data-feather="search" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Shipment Table -->
            <div class="bg-white rounded-xl shadow overflow-hidden" data-aos="fade-up">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Containers</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">BL No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bahrain ETA</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actual Bahrain ETA</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr id="shipments-loading-row">
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading shipments...</td>
                            </tr>
                        </tbody>
                    </table>
                    <div id="shipments-empty-state" class="hidden text-center text-gray-400 py-8">No shipments found.</div>
                </div>
            </div>

                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Mobile Bottom Navigation -->
        <nav class="md:hidden bg-white border-t border-gray-200 fixed bottom-0 w-full">
            <div class="flex justify-around">
                <a href="dashboard.html" class="flex flex-col items-center py-3 text-gray-500">
                    <i data-feather="home" class="w-5 h-5"></i>
                    <span class="text-xs mt-1">Home</span>
                </a>
                <a href="tasks.html" class="flex flex-col items-center py-3 text-gray-500">
                    <i data-feather="check-square" class="w-5 h-5"></i>
                    <span class="text-xs mt-1">Tasks</span>
                </a>
                <a href="#" class="flex flex-col items-center py-3 text-indigo-600">
                    <i data-feather="truck" class="w-5 h-5"></i>
                    <span class="text-xs mt-1">Shipments</span>
                </a>
                <a href="complaints.html" class="flex flex-col items-center py-3 text-gray-500">
                    <i data-feather="alert-circle" class="w-5 h-5"></i>
                    <span class="text-xs mt-1">Complaints</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- Enhanced Shipment Form Modal -->
    <div id="shipmentFormModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-0">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-[98vw] max-h-[98vh] overflow-y-auto flex flex-col" style="height:98vh;">
            <div class="sticky top-0 bg-white z-10 p-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">New Shipment</h2>
                        <p class="text-gray-600 text-sm mt-1">Fill in all required fields marked with *</p>
                    </div>
                    <button onclick="closeShipmentForm()" class="text-gray-500 hover:text-gray-700 transition">
                        <i data-feather="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            
            <form id="shipmentForm" class="flex-1 p-4 overflow-y-auto">
                <!-- Section: Shipment Details (one line, 3 fields) -->
                <div class="mb-2">
                    <h3 class="text-base font-semibold text-gray-800 mb-2 flex items-center border-b pb-1">
                        <span class="bg-indigo-100 text-indigo-600 rounded-full p-1 mr-2">
                            <i data-feather="info" class="w-4 h-4"></i>
                        </span>
                        Shipment Details
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-2">
                        <div class="flex flex-col max-w-xs">
                            <label class="block text-gray-700 mb-1">Source*</label>
                            <select name="source" required class="px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition text-sm">
                                <option value="">Select Source</option>
                                <option value="TMC">TMC</option>
                                <option value="TMAP">TMAP</option>
                                <option value="TMAP-OIL">TMAP-OIL</option>
                                <option value="TMHC">TMHC</option>
                                <option value="OTHER">OTHER</option>
                            </select>
                        </div>
                        <div class="flex flex-col max-w-xs">
                            <label class="block text-gray-700 mb-1">Invoice*</label>
                            <input type="text" name="invoice" required class="px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition text-sm" placeholder="Enter invoice number">
                        </div>
                        <div class="flex flex-col max-w-xs">
                            <label class="block text-gray-700 mb-1">BL No* <span class="text-xs text-gray-400">(Bill of Lading Number)</span></label>
                            <input type="text" name="blNo" required class="px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition text-sm" placeholder="Enter BL number">
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="block text-gray-700 mb-1 font-semibold">Containers*</label>
                        <div id="containers-list" class="mb-1"></div>
                        <button type="button" id="add-container-btn" class="mt-1 bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 text-xs font-medium flex items-center">
                            <i data-feather="plus" class="w-4 h-4 mr-1"></i> Add Container
                        </button>
                    </div>
                </div>

                <!-- Section: Dates & ETA (two lines, 3 fields each) -->
                <div class="mb-2">
                    <h3 class="text-base font-semibold text-gray-800 mb-2 flex items-center border-b pb-1">
                        <span class="bg-indigo-100 text-indigo-600 rounded-full p-1 mr-2">
                            <i data-feather="calendar" class="w-4 h-4"></i>
                        </span>
                        Dates & ETA
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-2">
                        <div>
                            <label class="block text-gray-700 mb-1">Bahrain ETA*</label>
                            <input type="date" name="bahrainETA" required class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition text-sm">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Original Document Receipt Date*</label>
                            <input type="date" name="originalDocReceiptDate" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition text-sm">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Actual Bahrain ATA</label>
                            <input type="date" name="actualBahrainETA" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition text-sm">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-gray-700 mb-1">Last Storage Day</label>
                            <input type="date" name="lastStorageDay" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition text-sm">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">W/H ETA (Requested by Parts)*</label>
                            <input type="date" name="whETARequested" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition text-sm">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Shipping Liner Arrival Expected Date*</label>
                            <input type="date" name="shippingLinerArrival" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition text-sm">
                        </div>
                    </div>
                </div>

                <!-- Section: Line Items (one line, 4 fields) -->
                <div class="mb-2">
                    <h3 class="text-base font-semibold text-gray-800 mb-2 flex items-center border-b pb-1">
                        <span class="bg-purple-100 text-purple-600 rounded-full p-1 mr-2">
                            <i data-feather="list" class="w-4 h-4"></i>
                        </span>
                        Line Items
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-gray-700 mb-1">Total Cases*</label>
                            <input type="number" name="totalCases" required min="0" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition text-sm" placeholder="Enter total cases">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Dom Lines</label>
                            <input type="number" name="domLines" min="0" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition text-sm" placeholder="Enter dom lines">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Bulk Lines</label>
                            <input type="number" name="bulkLines" min="0" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition text-sm" placeholder="Enter bulk lines">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Total Lines</label>
                            <input type="number" name="total" min="0" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition text-sm" placeholder="Enter total lines">
                        </div>
                    </div>
                </div>



                <!-- Form actions -->
                <!-- Section: Remarks (compressed two-column) -->
                <div class="mb-2">
                    <h3 class="text-base font-semibold text-gray-800 mb-2 flex items-center border-b pb-1">
                        <span class="bg-indigo-100 text-indigo-600 rounded-full p-1 mr-2">
                            <i data-feather="message-square" class="w-4 h-4"></i>
                        </span>
                        Remarks
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-gray-700 mb-1">Remarks 1</label>
                            <textarea name="remarks1" required rows="2" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition text-sm" placeholder="Additional notes..."></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Remarks 2</label>
                            <textarea name="remarks2" rows="2" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition text-sm" placeholder="Additional notes..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="sticky bottom-0 bg-white pt-4 pb-2 border-t border-gray-200">
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="closeShipmentForm()" class="px-6 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition font-medium text-base">
                            Cancel
                        </button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 px-8 rounded-lg transition transform hover:scale-[1.02] flex items-center text-base">
                            <i data-feather="save" class="mr-2 w-5 h-5"></i> Save Shipment
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        AOS.init();
        feather.replace();
        
        // Mobile menu toggle
        document.getElementById('menu-toggle').addEventListener('click', function() {
            document.getElementById('mobile-menu').classList.remove('hidden');
        });
        
        document.getElementById('close-menu').addEventListener('click', function() {
            document.getElementById('mobile-menu').classList.add('hidden');
        });

        // Enhanced Shipment form functions
        function openShipmentForm() {
            const modal = document.getElementById('shipmentFormModal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            // Reset containers UI
            renderContainersList([{ size: '40', count: 1 }]);
            // Focus first input field when modal opens
            setTimeout(() => {
                const firstInput = modal.querySelector('input, select, textarea');
                if (firstInput) firstInput.focus();
            }, 100);
        }

        function closeShipmentForm() {
            document.getElementById('shipmentFormModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            document.getElementById('shipmentForm').reset();
            renderContainersList([{ size: '40', count: 1 }]);
        }

        // Dynamic containers UI logic
        function renderContainersList(containers) {
            const list = document.getElementById('containers-list');
            list.innerHTML = '';
            containers.forEach((container, idx) => {
                const row = document.createElement('div');
                row.className = 'flex items-center space-x-2 mb-2';
                row.innerHTML = `
                    <input type="number" name="containerCount" min="1" required class="w-24 px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" placeholder="Count" value="${container.count}" />
                    <select name="containerSize" required class="w-32 px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                        <option value="40" ${container.size === '40' ? 'selected' : ''}>40 feet</option>
                        <option value="20" ${container.size === '20' ? 'selected' : ''}>20 feet</option>
                    </select>
                    <button type="button" class="remove-container-btn text-red-500 hover:text-red-700 px-2 py-1" data-idx="${idx}" title="Remove"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                `;
                list.appendChild(row);
            });
            feather.replace();
            // Hide remove button if only one row
            list.querySelectorAll('.remove-container-btn').forEach(btn => {
                if (containers.length === 1) btn.style.display = 'none';
                else btn.style.display = '';
            });
        }

        // State for containers in modal
        let containersState = [{ size: '40', count: 1 }];
        document.addEventListener('DOMContentLoaded', () => {
            renderContainersList(containersState);
            document.getElementById('add-container-btn').addEventListener('click', () => {
                containersState.push({ size: '40', count: 1 });
                renderContainersList(containersState);
            });
            document.getElementById('containers-list').addEventListener('input', (e) => {
                const rows = Array.from(document.getElementById('containers-list').children);
                containersState = rows.map(row => {
                    return {
                        count: Number(row.querySelector('input[name="containerCount"]').value) || 1,
                        size: row.querySelector('select[name="containerSize"]').value
                    };
                });
            });
            document.getElementById('containers-list').addEventListener('click', (e) => {
                if (e.target.closest('.remove-container-btn')) {
                    const idx = Number(e.target.closest('.remove-container-btn').getAttribute('data-idx'));
                    if (containersState.length > 1) {
                        containersState.splice(idx, 1);
                        renderContainersList(containersState);
                    }
                }
            });
        });

        // Mobile menu toggle
        document.getElementById('menu-toggle').addEventListener('click', function() {
            document.getElementById('mobile-menu').classList.remove('hidden');
        });
        
        document.getElementById('close-menu').addEventListener('click', function() {
            document.getElementById('mobile-menu').classList.add('hidden');
        });

        // Enhanced Shipment form functions
        function openShipmentForm() {
            const modal = document.getElementById('shipmentFormModal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Focus first input field when modal opens
            setTimeout(() => {
                const firstInput = modal.querySelector('input, select, textarea');
                if (firstInput) firstInput.focus();
            }, 100);
        }

        function closeShipmentForm() {
            document.getElementById('shipmentFormModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            document.getElementById('shipmentForm').reset();
        }
    </script>

    <!-- Place this at the end of the body -->
    <script type="module">
      import { db } from './firebase-config.js';
      import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

            // Form submission with validation
            document.getElementById('shipmentForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                // --- Ensure containersState is up-to-date with UI before saving ---
                const rows = Array.from(document.getElementById('containers-list').children);
                containersState = rows.map(row => {
                    return {
                        count: Number(row.querySelector('input[name="containerCount"]').value) || 1,
                        size: row.querySelector('select[name="containerSize"]').value
                    };
                });
                const formData = new FormData(this);
                const shipmentData = Object.fromEntries(formData.entries());
                // Validate only the truly required fields
                if (!shipmentData.source || !shipmentData.invoice || !shipmentData.blNo || !shipmentData.bahrainETA || !shipmentData.totalCases || !shipmentData.domLines || !shipmentData.bulkLines || !shipmentData.remarks1) {
                    alert('Please fill in all required fields marked with *');
                    return;
                }
                // Parse number fields
                shipmentData.totalCases = Number(shipmentData.totalCases);
                if (shipmentData.domLines) shipmentData.domLines = Number(shipmentData.domLines);
                if (shipmentData.bulkLines) shipmentData.bulkLines = Number(shipmentData.bulkLines);
                if (shipmentData.total) shipmentData.total = Number(shipmentData.total);
                // Parse date fields
                if (shipmentData.originalDocReceiptDate) shipmentData.originalDocReceiptDate = new Date(shipmentData.originalDocReceiptDate);
                if (shipmentData.actualBahrainETA) shipmentData.actualBahrainETA = new Date(shipmentData.actualBahrainETA);
                if (shipmentData.lastStorageDay) shipmentData.lastStorageDay = new Date(shipmentData.lastStorageDay);
                shipmentData.createdAt = serverTimestamp();

                // --- Save containers array ---
                if (typeof containersState !== 'undefined' && Array.isArray(containersState) && containersState.length > 0) {
                    shipmentData.containers = containersState.map(c => ({
                        size: c.size,
                        count: Number(c.count)
                    }));
                }
                // Remove old single container fields if present
                delete shipmentData.containerCount;
                delete shipmentData.containerSize;

                try {
                    await addDoc(collection(db, 'shipments'), shipmentData);
                    alert('Shipment saved to Firestore!');
                    closeShipmentForm();
                } catch (error) {
                    console.error('Error saving shipment to Firestore:', error);
                    alert('Failed to save shipment to Firestore.');
                }
            });
        </script>

        <!-- Shipment Detail Modal -->
        <div id="shipmentDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 relative">
                <button id="closeDetailModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Shipment Details</h2>
                <div id="shipmentDetailLoading" class="text-center text-gray-500 py-8">Loading...</div>
                <div id="shipmentDetailNotFound" class="text-center text-red-500 py-8 hidden">Shipment not found.</div>

                <form id="shipmentDetailForm" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm text-gray-600">Source</label>
                            <input name="source" disabled class="mt-1 w-full border rounded px-2 py-2 bg-gray-100" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">Invoice</label>
                            <input name="invoice" disabled class="mt-1 w-full border rounded px-2 py-2 bg-gray-100" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">BL No</label>
                            <input name="blNo" disabled class="mt-1 w-full border rounded px-2 py-2 bg-gray-100" />
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div>
                            <label class="block text-sm text-gray-600">Bahrain ETA</label>
                            <input type="date" name="bahrainETA" class="mt-1 w-full border rounded px-2 py-2" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">Original Document Receipt Date</label>
                            <input type="date" name="originalDocReceiptDate" class="mt-1 w-full border rounded px-2 py-2" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">Actual Bahrain ATA</label>
                            <input type="date" name="actualBahrainETA" class="mt-1 w-full border rounded px-2 py-2" />
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
                        <div>
                            <label class="block text-sm text-gray-600">Total Cases</label>
                            <input type="number" name="totalCases" disabled class="mt-1 w-full border rounded px-2 py-2 bg-gray-100" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">Dom Lines</label>
                            <input type="number" name="domLines" disabled class="mt-1 w-full border rounded px-2 py-2 bg-gray-100" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">Bulk Lines</label>
                            <input type="number" name="bulkLines" disabled class="mt-1 w-full border rounded px-2 py-2 bg-gray-100" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600">Total Lines</label>
                            <input type="number" name="total" disabled class="mt-1 w-full border rounded px-2 py-2 bg-gray-100" />
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" id="deleteShipmentBtn" class="px-4 py-2 border rounded text-red-700">Delete</button>
                        <button type="button" id="cancelEditBtn" class="px-4 py-2 border rounded">Cancel</button>
                        <button type="submit" id="updateShipmentBtn" class="px-4 py-2 bg-indigo-600 text-white rounded">Update</button>
                    </div>
                </form>
            </div>
        </div>

        <script type="module">
            import { db } from './firebase-config.js';
            import { doc, getDoc, updateDoc, deleteDoc, collection, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

            let detailModalEl = document.getElementById('shipmentDetailModal');
            let detailForm = document.getElementById('shipmentDetailForm');
            let loadingEl = document.getElementById('shipmentDetailLoading');
            let notFoundEl = document.getElementById('shipmentDetailNotFound');
            let closeBtn = document.getElementById('closeDetailModal');
            let cancelBtn = document.getElementById('cancelEditBtn');
            let deleteBtn = document.getElementById('deleteShipmentBtn');
            let currentDocId = null;

            function formatDateInput(val) {
                if (!val) return '';
                if (val.seconds) return new Date(val.seconds * 1000).toISOString().slice(0,10);
                if (typeof val === 'string' || typeof val === 'number') return new Date(val).toISOString().slice(0,10);
                if (val instanceof Date) return val.toISOString().slice(0,10);
                return '';
            }

            // Open modal and load document
            window.openDetailModal = async function(docId) {
                currentDocId = docId;
                loadingEl.classList.remove('hidden');
                notFoundEl.classList.add('hidden');
                detailForm.classList.add('hidden');
                detailModalEl.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                try {
                    const ref = doc(db, 'shipments', docId);
                    const snap = await getDoc(ref);
                    if (!snap.exists()) {
                        loadingEl.classList.add('hidden');
                        notFoundEl.classList.remove('hidden');
                        return;
                    }
                    const data = snap.data();
                    // populate form
                    detailForm.reset();
                    detailForm.source.value = data.source || '';
                    detailForm.invoice.value = data.invoice || '';
                    detailForm.blNo.value = data.blNo || '';
                    detailForm.containerCount && (detailForm.containerCount.value = data.containerCount || '');
                    detailForm.containerSize && (detailForm.containerSize.value = data.containerSize || '');
                    detailForm.bahrainETA && (detailForm.bahrainETA.value = formatDateInput(data.bahrainETA || data.bahrainEta));
                    detailForm.originalDocReceiptDate && (detailForm.originalDocReceiptDate.value = formatDateInput(data.originalDocReceiptDate));
                    detailForm.actualBahrainETA && (detailForm.actualBahrainETA.value = formatDateInput(data.actualBahrainETA));
                    detailForm.lastStorageDay && (detailForm.lastStorageDay.value = formatDateInput(data.lastStorageDay));
                    detailForm.whETARequested && (detailForm.whETARequested.value = formatDateInput(data.whETARequested));
                    detailForm.whETAConfirmed && (detailForm.whETAConfirmed.value = formatDateInput(data.whETAConfirmed));
                    detailForm.shippingLinerArrival && (detailForm.shippingLinerArrival.value = formatDateInput(data.shippingLinerArrival));
                    detailForm.totalCases && (detailForm.totalCases.value = data.totalCases || '');
                    detailForm.domLines && (detailForm.domLines.value = data.domLines || '');
                    detailForm.bulkLines && (detailForm.bulkLines.value = data.bulkLines || '');
                    detailForm.total && (detailForm.total.value = data.total || '');
                    detailForm.remarks1 && (detailForm.remarks1.value = data.remarks1 || '');
                    detailForm.remarks2 && (detailForm.remarks2.value = data.remarks2 || '');

                    loadingEl.classList.add('hidden');
                    detailForm.classList.remove('hidden');
                } catch (err) {
                    console.error('Failed to load shipment', err);
                    loadingEl.classList.add('hidden');
                    notFoundEl.classList.remove('hidden');
                }
            };

            function closeDetailModal() {
                detailModalEl.classList.add('hidden');
                document.body.style.overflow = 'auto';
                currentDocId = null;
            }

            closeBtn && closeBtn.addEventListener('click', closeDetailModal);
            cancelBtn && cancelBtn.addEventListener('click', closeDetailModal);

            // Delete
            deleteBtn && deleteBtn.addEventListener('click', async () => {
                if (!currentDocId) return;
                if (!confirm('Are you sure you want to delete this shipment? This action cannot be undone.')) return;
                try {
                    await deleteDoc(doc(db, 'shipments', currentDocId));
                    if (window.toast) window.toast('Shipment deleted', 'success');
                    closeDetailModal();
                } catch (err) {
                    console.error('Delete failed', err);
                    alert('Failed to delete shipment.');
                }
            });

            // Update
            detailForm && detailForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentDocId) return;
                const formData = new FormData(detailForm);
                const updateData = Object.fromEntries(formData.entries());

                // convert numeric fields
                if (updateData.totalCases) updateData.totalCases = Number(updateData.totalCases);
                if (updateData.domLines) updateData.domLines = Number(updateData.domLines);
                if (updateData.bulkLines) updateData.bulkLines = Number(updateData.bulkLines);
                if (updateData.total) updateData.total = Number(updateData.total);
                if (updateData.containerCount) updateData.containerCount = Number(updateData.containerCount);

                // convert date fields
                ['bahrainETA','originalDocReceiptDate','actualBahrainETA','lastStorageDay','whETARequested','whETAConfirmed','shippingLinerArrival','actualClearedDate'].forEach(f => {
                    if (updateData[f]) updateData[f] = new Date(updateData[f]);
                });

                try {
                    await updateDoc(doc(db, 'shipments', currentDocId), updateData);
                    if (window.toast) window.toast('Shipment updated!', 'success');
                    closeDetailModal();
                } catch (err) {
                    console.error('Update failed', err);
                    alert('Failed to update shipment. ' + (err && err.message ? err.message : ''));
                }
            });

            // expose close function for other scripts if needed
            window.closeDetailModal = closeDetailModal;

            // Live Firestore listener (kept as before)
            const detailLoadingRow = document.getElementById("shipments-loading-row");
            const detailEmptyState = document.getElementById("shipments-empty-state");
            detailLoadingRow.classList.remove('hidden');
            detailEmptyState.classList.add('hidden');
            // Define query for this module script
            const detailQuery = query(collection(db, 'shipments'), orderBy('createdAt', 'desc'));
            onSnapshot(detailQuery, (snapshot) => {
                detailLoadingRow.classList.add('hidden');
                lastSnapshot = snapshot;
                const shipments = snapshot.docs.map(doc => doc.data());
                renderShipments(shipments, snapshot.docs);
            });
        </script>
    </body>
</html>
